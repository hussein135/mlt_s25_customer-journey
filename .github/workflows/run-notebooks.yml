name: Run Notebooks

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  test-notebooks:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "requirements.txt not found in repo root."
            exit 1
          fi
          # أدوات تشغيل الـ notebooks
          pip install nbclient nbformat ipykernel
          # دعم قراءة Excel / xltx غالباً يحتاج openpyxl
          pip install openpyxl

      - name: Set PYTHONPATH
        run: echo "PYTHONPATH=$GITHUB_WORKSPACE" >> $GITHUB_ENV

      - name: Smoke test system (load processed files)
        run: |
          python - <<'PY'
          from pathlib import Path
          from src.system import CustomerJourneySystem

          cjs = CustomerJourneySystem(processed_dir=Path("data/processed"))
          out = cjs.add_account(account_id="A001", country="AT", solution="MRS")
          assert "top4_by_country" in out
          print("Smoke test OK")
          PY

      - name: Run notebooks (cell by cell)
        run: |
          python - <<'PY'
          import glob
          from pathlib import Path
          import nbformat
          from nbclient import NotebookClient

          # اكتشف جميع الدفاتر ورتبها
          notebooks = sorted(glob.glob("notebooks/*.ipynb"))
          if not notebooks:
              raise SystemExit("No notebooks found in notebooks/")

          raw_file = Path("data/raw/data_all.xltx")
          skip_cleaning = not raw_file.exists()

          print("Detected notebooks:")
          for nb in notebooks:
              print(" -", nb)

          print("\nRaw file exists:", raw_file.exists(), "| path:", str(raw_file))

          ran_any = False

          for path in notebooks:
              name = Path(path).name

              # إذا ملف الخام غير موجود، تخطّى فقط دفتر التنظيف
              if skip_cleaning and name == "01_data_cleaning.ipynb":
                  print(f"SKIP (raw file missing): {path}")
                  continue

              print(f"\nRunning: {path}")
              nb = nbformat.read(path, as_version=4)
              client = NotebookClient(nb, timeout=1200, kernel_name="python3")
              client.execute()
              print(f"OK: {path}")
              ran_any = True

          if not ran_any:
              raise SystemExit("No notebooks were executed (all skipped). Check conditions/paths.")

          print("\nAll executed notebooks finished successfully.")
          PY
