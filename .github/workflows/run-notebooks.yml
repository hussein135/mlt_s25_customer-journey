name: Run Notebooks

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  test-notebooks:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "requirements.txt not found. Please add it in repo root."
            exit 1
          fi
          pip install nbclient nbformat ipykernel

      - name: Set PYTHONPATH
        run: echo "PYTHONPATH=$GITHUB_WORKSPACE" >> $GITHUB_ENV

      - name: Run notebooks (cell by cell)
        run: |
          python - <<'PY'
          from nbclient import NotebookClient
          import nbformat
          from pathlib import Path

          # شغّل فقط الدفاتر التي لا تعتمد على data/raw
          # عدّل هذه القائمة لتطابق أسماء الدفاتر الموجودة عندك فعلياً
          notebooks = [
              "notebooks/02_journey_analysis.ipynb",
              "notebooks/03_decision_tree_next_actions.ipynb",
              "notebooks/04_top_actions_aggregates.ipynb",
          ]

          ran_any = False

          for path in notebooks:
              p = Path(path)
              if not p.exists():
                  print(f"SKIP (not found): {path}")
                  continue

              ran_any = True
              print(f"Running: {path}")
              nb = nbformat.read(path, as_version=4)
              client = NotebookClient(nb, timeout=900, kernel_name="python3")
              client.execute()
              print(f"OK: {path}")

          if not ran_any:
              raise SystemExit("No notebooks were executed. Please verify notebook paths in workflow.")

          print("All selected notebooks executed successfully.")
          PY
